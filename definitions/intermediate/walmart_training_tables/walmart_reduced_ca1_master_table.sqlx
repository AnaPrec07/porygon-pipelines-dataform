config {
  type: "table",
  schema: "walmart_training_tables",
  description: "walmart master table.",
  tags: ["intermediate", "master"]
}


  SELECT 
    -- context fields
    tgt.ctx_date_month,
    tgt.ctx_cat_id,
    tgt.ctx_dept_id,
    tgt.ctx_item_id,
    tgt.ctx_state_id,
    tgt.ctx_store_id,

    -- target fields
    tgt_monthly_sales,
    tgt_days_is_zero_sales,
    tgt_monthly_sales_sum_3_next_months,
    tgt_monthly_sales_lead_1_months,
    tgt_monthly_sales_lead_2_months,
    tgt_monthly_sales_lead_3_months,
    tgt_days_is_zero_sales_lead_1_months,
    tgt_days_is_zero_sales_lead_2_months,
    tgt_days_is_zero_sales_lead_3_months,
    tgt_days_is_zero_sales_lead_4_months,

    -- outlier filters
    outlier_threshold_q97,
    is_tgt_outlier,
    is_outlier_3m_tgt,

    -- stockout filters
    is_stockout_month_lag_sale,
    is_stockout_month_lead_sale,
    fea_max_days_since_last_sale,
    fea_min_days_to_next_sale,
    stockout_threshold_q97,
    is_stockout_tgt_lag,
    is_stockout_tgt_lead,
    is_incomplete_3m_tgt,

    -- item_longevity_filters
    ctx_first_date,
    is_one_year_old,
    is_six_months_old,
    is_3_months_old

    -- reduced features
    fea_item_monthly_sales,
    fea_item_monthly_sales_roll_avg_12_months,
    fea_item_monthly_sales_roll_avg_3_months,
    fea_state_item_monthly_sales,
    fea_item_monthly_sales_roll_std_12_months,
    fea_state_item_monthly_sales_roll_avg_12_months,
    fea_foods_monthly_sales_roll_avg_6_months,
    fea_num_days_item_is_zero_sales_lag_1_months,
    fea_dept_id_encoded,
    fea_num_days_item_is_zero_sales_roll_std_12_months,
    fea_state_item_monthly_sales_roll_std_12_months,
    fea_num_days_item_is_zero_sales_roll_avg_12_months,
    fea_ca_1_monthly_sales_delta,
    mean_temperature_roll_avg_6_months,
    mean_dewp_roll_avg_6_months,
    mean_wdsp_roll_avg_6_months,
    fea_hobbies_monthly_sales_roll_std_12_months,
    fea_item_vs_dept_price_ratio_roll_std_6_months,
    fea_state_price_std,
    fea_tx_unemployment_rate_roll_std_6_months,
    std_dewp,
    fea_item_monthly_sales_roll_avg_6_months,
    fea_hobbies_2_monthly_sales_roll_std_12_months,
    fea_ca_4_monthly_sales_roll_std_12_months,
    fea_ca_3_monthly_sales_roll_avg_6_months,
    fea_all_item_monthly_sales,
    fea_item_store_price_std_roll_avg_6_months,
    fea_ca_2_monthly_sales_roll_std_6_months,
    fea_wi_1_monthly_sales_roll_avg_3_months,
    fea_hobbies_2_monthly_sales_roll_std_6_months,
    fea_tx_3_monthly_sales_roll_avg_3_months,
    fea_item_store_price_min_roll_avg_6_months,
    mean_dewp_roll_avg_3_months,
    fea_item_store_price_avg_roll_avg_12_months,
    fea_item_price_min,
    fea_state_item_monthly_sales_roll_avg_3_months,
    fea_store_price_avg,
    mean_snow_ice_pellets_roll_avg_3_months,
    mean_wdsp_roll_std_12_months,
    fea_foods_1_monthly_sales_roll_std_3_months,
    fea_item_vs_dept_price_ratio_roll_avg_12_months,
    fea_hobbies_1_monthly_sales_roll_avg_3_months,
    mean_rain_drizzle_roll_std_3_months,
    fea_ca_monthly_sales_delta_roll_avg_3_months,
    mean_rain_drizzle_roll_std_6_months,
    fea_tx_monthly_sales_delta_roll_std_6_months,
    fea_tx_monthly_sales_delta_roll_std_3_months,
    fea_num_days_item_is_zero_sales_roll_std_6_months,
    fea_dept_price_std,
    fea_ca_2_monthly_sales_roll_avg_3_months,
    fea_item_id_encoded,
    fea_all_item_monthly_sales_roll_avg_12_months,
    fea_state_item_num_days_is_zero_sales_roll_std_12_months,
    fea_foods_monthly_sales_roll_avg_3_months,
    fea_item_vs_dept_price_ratio_roll_avg_6_months,
    fea_price_pct_change_1m,
    fea_all_item_monthly_sales_roll_std_12_months,
    fea_all_item_num_days_is_zero_sales,
    fea_ca_monthly_sales_roll_avg_6_months,
    std_temperature,
    fea_item_store_price_min_roll_avg_12_months,
    fea_wi_monthly_sales_delta_roll_std_3_months,
    fea_item_store_price_max_roll_std_6_months,
    fea_gas_price_per_gallon_roll_std_3_months,
    fea_state_item_monthly_sales_roll_avg_6_months,
    fea_num_days_item_is_zero_sales_roll_avg_6_months,
    fea_hobbies_monthly_sales_delta_roll_std_3_months,
    fea_hobbies_1_monthly_sales_roll_avg_6_months,
    fea_household_1_monthly_sales_roll_std_3_months,
    fea_tx_monthly_sales_roll_avg_6_months,
    fea_item_store_price_max_roll_std_12_months,
    fea_dept_unique_items,
    mean_dewp_roll_std_6_months,
    fea_foods_2_monthly_sales_roll_avg_12_months,
    fea_ca_monthly_sales_delta_roll_std_3_months,
    fea_item_price_min_roll_avg_12_months,
    mean_visib_roll_avg_6_months,
    fea_household_monthly_sales_roll_std_3_months,
    fea_tx_1_monthly_sales_roll_avg_6_months,
    fea_item_store_price_avg_roll_std_12_months,
    fea_gas_price_per_gallon_roll_avg_6_months,
    mean_wdsp_roll_avg_3_months,
    fea_item_vs_state_price_ratio_roll_std_6_months,
    fea_item_vs_store_price_ratio_roll_avg_12_months,
    fea_foods_1_monthly_sales_roll_avg_12_months,
    fea_foods_1_monthly_sales_roll_std_6_months,
    mean_gust_roll_std_3_months,
    fea_household_2_monthly_sales_roll_std_6_months,
    fea_state_item_monthly_sales_roll_std_3_months,
    fea_item_store_price_std_roll_avg_12_months,
    mean_sndp_roll_std_12_months,
    fea_ca_unemployment_rate_roll_std_12_months,
    mean_temperature_roll_avg_12_months,
    fea_all_item_monthly_sales_roll_avg_6_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_6_months,
    max_dewp,
    fea_item_store_price_std_roll_avg_3_months,
    fea_item_store_price_max_roll_avg_6_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_12_months,
    mean_temperature,
    fea_price_pct_change_3m,
    fea_ca_1_monthly_sales_roll_std_3_months,
    fea_item_price_std_roll_avg_6_months,
    fea_foods_3_monthly_sales_roll_std_6_months,
    fea_tx_2_monthly_sales_roll_std_3_months,
    fea_hobbies_monthly_sales_delta_roll_std_12_months,
    fea_tx_3_monthly_sales_roll_std_12_months,
    fea_item_monthly_sales_roll_std_3_months,
    fea_household_monthly_sales_roll_std_12_months,
    fea_price_abs_change_3m,
    fea_gas_price_per_gallon_roll_std_6_months,
    fea_state_item_monthly_sales_roll_std_6_months,
    fea_tx_2_monthly_sales_roll_avg_6_months,
    fea_gas_price_per_gallon_roll_std_12_months,
    fea_wi_3_monthly_sales_roll_std_12_months,
    fea_household_2_monthly_sales_roll_avg_3_months,
    fea_hobbies_2_monthly_sales_roll_avg_6_months,
    fea_num_days_item_is_zero_sales,
    fea_foods_2_monthly_sales_roll_std_12_months,
    fea_tx_monthly_sales_roll_avg_12_months,
    fea_hobbies_2_monthly_sales_roll_std_3_months,
    mean_fog,
    fea_dept_price_avg,
    mean_temperature_roll_avg_3_months,
    fea_ca_1_monthly_sales_roll_std_12_months,
    fea_foods_2_monthly_sales_roll_std_6_months,
    fea_gas_price_per_gallon_roll_avg_12_months,
    fea_foods_monthly_sales_roll_std_3_months,
    fea_ca_monthly_sales_delta_roll_std_6_months,
    fea_dept_price_min_roll_avg_3_months,
    fea_hobbies_1_monthly_sales_roll_std_6_months,
    fea_item_store_price_max_roll_std_3_months,
    mean_visib_roll_avg_12_months,
    mean_sndp_roll_std_6_months,
    fea_tx_monthly_sales_roll_std_6_months,
    fea_household_monthly_sales_roll_std_6_months,
    fea_item_price_std_roll_avg_12_months,
    mean_sndp_roll_avg_3_months,
    fea_wi_1_monthly_sales_roll_std_3_months,
    mean_sndp_roll_std_3_months,
    fea_hobbies_2_monthly_sales_delta,
    fea_state_item_num_days_is_zero_sales_roll_std_6_months,
    mean_visib_roll_std_12_months,
    mean_prcp_roll_std_3_months,
    fea_item_vs_dept_price_ratio_roll_avg_3_months,
    fea_num_days_item_is_zero_sales_roll_avg_3_months,
    fea_item_monthly_sales_lag_2_months,
    fea_item_vs_dept_price_ratio_roll_std_3_months,
    fea_ca_3_monthly_sales_roll_avg_3_months,
    mean_visib_roll_avg_3_months,
    fea_item_store_price_avg_roll_std_6_months,
    fea_item_monthly_sales_roll_std_6_months,
    fea_wi_2_monthly_sales_roll_std_6_months,
    fea_item_store_price_min_roll_std_12_months,
    mean_snow_ice_pellets_roll_std_3_months,
    fea_item_vs_store_price_ratio_roll_avg_6_months,
    fea_hobbies_monthly_sales_delta_roll_avg_6_months,
    fea_item_price_min_roll_avg_6_months,
    mean_sndp,
    fea_wi_2_monthly_sales_roll_avg_3_months,
    fea_tx_monthly_sales_roll_avg_3_months,
    fea_all_item_monthly_sales_roll_avg_3_months,
    fea_foods_1_monthly_sales_delta,
    fea_wi_monthly_sales_delta_roll_avg_6_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_3_months,
    fea_num_days_item_is_zero_sales_roll_std_3_months,
    fea_foods_2_monthly_sales_roll_std_3_months,
    mean_wdsp,
    fea_item_price_avg_roll_std_12_months,
    fea_all_item_monthly_sales_roll_std_6_months,
    mean_temperature_roll_std_12_months,
    fea_household_1_monthly_sales_roll_std_6_months,
    mean_dewp_roll_avg_12_months,
    fea_item_store_price_max_roll_avg_12_months,
    fea_ca_unemployment_rate_roll_std_6_months,
    fea_household_monthly_sales_delta,
    fea_wi_1_monthly_sales_delta,
    fea_state_item_num_days_is_zero_sales,
    fea_item_store_price_min_roll_std_3_months,
    fea_wi_monthly_sales_roll_std_3_months,
    fea_item_store_price_std_roll_std_6_months,
    mean_wdsp_roll_std_6_months,
    mean_gust_roll_std_6_months,
    fea_price_abs_change_1m,
    fea_tx_1_monthly_sales_roll_std_3_months,
    fea_hobbies_1_monthly_sales_delta,
    fea_state_item_num_days_is_zero_sales_roll_std_3_months,
    fea_item_monthly_sales_lag_4_months,
    fea_ca_2_monthly_sales_roll_std_12_months,
    fea_state_price_min
    
FROM ${ref("walmart_master_table")} m
WHERE ctx_store_id = "CA_1"