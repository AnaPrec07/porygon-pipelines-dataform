config {
  type: "table",
  schema: "walmart_training_tables",
  description: "versioned training tables.",
  tags: ["intermediate"],
  assertions: {
    nonNull: [
        "ctx_date_month",
        "ctx_cat_id",
        "ctx_dept_id",
        "ctx_item_id",
        "ctx_state_id",
        "ctx_store_id"
    ],
    uniqueKey: [
        "ctx_date_month",
        "ctx_cat_id",
        "ctx_dept_id",
        "ctx_item_id",
        "ctx_state_id",
        "ctx_store_id"
    ]
  }
}

SELECT 
    tgt.ctx_date_month,
    tgt.ctx_cat_id,
    tgt.ctx_dept_id,
    tgt.ctx_item_id,
    tgt.ctx_state_id,
    tgt.ctx_store_id,
    tgt_monthly_sales,
    tgt_monthly_sales_lead_1_months,
    tgt_monthly_sales_lead_2_months,
    tgt_monthly_sales_lead_3_months,
    tgt_monthly_sales_lead_4_months,
    tgt_days_is_zero_sales,
    tgt_days_is_zero_sales_lead_1_months,
    tgt_days_is_zero_sales_lead_2_months,
    tgt_days_is_zero_sales_lead_3_months,
    tgt_days_is_zero_sales_lead_4_months,
    fea_is_weekend,
    fea_is_event_1,
    fea_is_event_2,
    fea_is_sporting_event,
    fea_is_cultural_event,
    fea_is_national_event,
    fea_is_religious_event,
    fea_is_snap_ca,
    fea_is_snap_tx,
    fea_is_snap_wi,
    fea_month_sin,
    fea_ca_monthly_sales_roll_avg_3_months,
    fea_ca_monthly_sales_roll_std_3_months,
    fea_ca_monthly_sales_roll_avg_6_months,
    fea_ca_monthly_sales_roll_std_6_months,
    fea_ca_monthly_sales_roll_avg_12_months,
    fea_ca_monthly_sales_roll_std_12_months,
    fea_tx_monthly_sales_roll_avg_3_months,
    fea_tx_monthly_sales_roll_std_3_months,
    fea_tx_monthly_sales_roll_avg_6_months,
    fea_tx_monthly_sales_roll_std_6_months,
    fea_tx_monthly_sales_roll_avg_12_months,
    fea_tx_monthly_sales_roll_std_12_months,
    fea_wi_monthly_sales_roll_avg_3_months,
    fea_wi_monthly_sales_roll_std_3_months,
    fea_wi_monthly_sales_roll_avg_6_months,
    fea_wi_monthly_sales_roll_std_6_months,
    fea_wi_monthly_sales_roll_avg_12_months,
    fea_wi_monthly_sales_roll_std_12_months,
    fea_hobbies_monthly_sales_roll_avg_3_months,
    fea_hobbies_monthly_sales_roll_std_3_months,
    fea_hobbies_monthly_sales_roll_avg_6_months,
    fea_hobbies_monthly_sales_roll_std_6_months,
    fea_hobbies_monthly_sales_roll_avg_12_months,
    fea_hobbies_monthly_sales_roll_std_12_months,
    fea_household_monthly_sales_roll_avg_3_months,
    fea_household_monthly_sales_roll_std_3_months,
    fea_household_monthly_sales_roll_avg_6_months,
    fea_household_monthly_sales_roll_std_6_months,
    fea_household_monthly_sales_roll_avg_12_months,
    fea_household_monthly_sales_roll_std_12_months,
    fea_foods_monthly_sales_roll_avg_3_months,
    fea_foods_monthly_sales_roll_std_3_months,
    fea_foods_monthly_sales_roll_avg_6_months,
    fea_foods_monthly_sales_roll_std_6_months,
    fea_foods_monthly_sales_roll_avg_12_months,
    fea_foods_monthly_sales_roll_std_12_months,
    fea_hobbies_1_monthly_sales_roll_avg_3_months,
    fea_hobbies_1_monthly_sales_roll_std_3_months,
    fea_hobbies_1_monthly_sales_roll_avg_6_months,
    fea_hobbies_1_monthly_sales_roll_std_6_months,
    fea_hobbies_1_monthly_sales_roll_avg_12_months,
    fea_hobbies_1_monthly_sales_roll_std_12_months,
    fea_hobbies_2_monthly_sales_roll_avg_3_months,
    fea_hobbies_2_monthly_sales_roll_std_3_months,
    fea_hobbies_2_monthly_sales_roll_avg_6_months,
    fea_hobbies_2_monthly_sales_roll_std_6_months,
    fea_hobbies_2_monthly_sales_roll_avg_12_months,
    fea_hobbies_2_monthly_sales_roll_std_12_months,
    fea_household_1_monthly_sales_roll_avg_3_months,
    fea_household_1_monthly_sales_roll_std_3_months,
    fea_household_1_monthly_sales_roll_avg_6_months,
    fea_household_1_monthly_sales_roll_std_6_months,
    fea_household_1_monthly_sales_roll_avg_12_months,
    fea_household_1_monthly_sales_roll_std_12_months,
    fea_household_2_monthly_sales_roll_avg_3_months,
    fea_household_2_monthly_sales_roll_std_3_months,
    fea_household_2_monthly_sales_roll_avg_6_months,
    fea_household_2_monthly_sales_roll_std_6_months,
    fea_household_2_monthly_sales_roll_avg_12_months,
    fea_household_2_monthly_sales_roll_std_12_months,
    fea_foods_1_monthly_sales_roll_avg_3_months,
    fea_foods_1_monthly_sales_roll_std_3_months,
    fea_foods_1_monthly_sales_roll_avg_6_months,
    fea_foods_1_monthly_sales_roll_std_6_months,
    fea_foods_1_monthly_sales_roll_avg_12_months,
    fea_foods_1_monthly_sales_roll_std_12_months,
    fea_foods_2_monthly_sales_roll_avg_3_months,
    fea_foods_2_monthly_sales_roll_std_3_months,
    fea_foods_2_monthly_sales_roll_avg_6_months,
    fea_foods_2_monthly_sales_roll_std_6_months,
    fea_foods_2_monthly_sales_roll_avg_12_months,
    fea_foods_2_monthly_sales_roll_std_12_months,
    fea_foods_3_monthly_sales_roll_avg_3_months,
    fea_foods_3_monthly_sales_roll_std_3_months,
    fea_foods_3_monthly_sales_roll_avg_6_months,
    fea_foods_3_monthly_sales_roll_std_6_months,
    fea_foods_3_monthly_sales_roll_avg_12_months,
    fea_foods_3_monthly_sales_roll_std_12_months,
    fea_ca_1_monthly_sales_roll_avg_3_months,
    fea_ca_1_monthly_sales_roll_std_3_months,
    fea_ca_1_monthly_sales_roll_avg_6_months,
    fea_ca_1_monthly_sales_roll_std_6_months,
    fea_ca_1_monthly_sales_roll_avg_12_months,
    fea_ca_1_monthly_sales_roll_std_12_months,
    fea_ca_2_monthly_sales_roll_avg_3_months,
    fea_ca_2_monthly_sales_roll_std_3_months,
    fea_ca_2_monthly_sales_roll_avg_6_months,
    fea_ca_2_monthly_sales_roll_std_6_months,
    fea_ca_2_monthly_sales_roll_avg_12_months,
    fea_ca_2_monthly_sales_roll_std_12_months,
    fea_ca_3_monthly_sales_roll_avg_3_months,
    fea_ca_3_monthly_sales_roll_std_3_months,
    fea_ca_3_monthly_sales_roll_avg_6_months,
    fea_ca_3_monthly_sales_roll_std_6_months,
    fea_ca_3_monthly_sales_roll_avg_12_months,
    fea_ca_3_monthly_sales_roll_std_12_months,
    fea_ca_4_monthly_sales_roll_avg_3_months,
    fea_ca_4_monthly_sales_roll_std_3_months,
    fea_ca_4_monthly_sales_roll_avg_6_months,
    fea_ca_4_monthly_sales_roll_std_6_months,
    fea_ca_4_monthly_sales_roll_avg_12_months,
    fea_ca_4_monthly_sales_roll_std_12_months,
    fea_tx_1_monthly_sales_roll_avg_3_months,
    fea_tx_1_monthly_sales_roll_std_3_months,
    fea_tx_1_monthly_sales_roll_avg_6_months,
    fea_tx_1_monthly_sales_roll_std_6_months,
    fea_tx_1_monthly_sales_roll_avg_12_months,
    fea_tx_1_monthly_sales_roll_std_12_months,
    fea_tx_2_monthly_sales_roll_avg_3_months,
    fea_tx_2_monthly_sales_roll_std_3_months,
    fea_tx_2_monthly_sales_roll_avg_6_months,
    fea_tx_2_monthly_sales_roll_std_6_months,
    fea_tx_2_monthly_sales_roll_avg_12_months,
    fea_tx_2_monthly_sales_roll_std_12_months,
    fea_tx_3_monthly_sales_roll_avg_3_months,
    fea_tx_3_monthly_sales_roll_std_3_months,
    fea_tx_3_monthly_sales_roll_avg_6_months,
    fea_tx_3_monthly_sales_roll_std_6_months,
    fea_tx_3_monthly_sales_roll_avg_12_months,
    fea_tx_3_monthly_sales_roll_std_12_months,
    fea_wi_1_monthly_sales_roll_avg_3_months,
    fea_wi_1_monthly_sales_roll_std_3_months,
    fea_wi_1_monthly_sales_roll_avg_6_months,
    fea_wi_1_monthly_sales_roll_std_6_months,
    fea_wi_1_monthly_sales_roll_avg_12_months,
    fea_wi_1_monthly_sales_roll_std_12_months,
    fea_wi_2_monthly_sales_roll_avg_3_months,
    fea_wi_2_monthly_sales_roll_std_3_months,
    fea_wi_2_monthly_sales_roll_avg_6_months,
    fea_wi_2_monthly_sales_roll_std_6_months,
    fea_wi_2_monthly_sales_roll_avg_12_months,
    fea_wi_2_monthly_sales_roll_std_12_months,
    fea_wi_3_monthly_sales_roll_avg_3_months,
    fea_wi_3_monthly_sales_roll_std_3_months,
    fea_wi_3_monthly_sales_roll_avg_6_months,
    fea_wi_3_monthly_sales_roll_std_6_months,
    fea_wi_3_monthly_sales_roll_avg_12_months,
    fea_wi_3_monthly_sales_roll_std_12_months,
    fea_item_price_avg,
    fea_item_price_min,
    fea_item_price_max,
    fea_item_price_std,
    fea_store_price_avg,
    fea_store_price_min,
    fea_store_price_max,
    fea_store_price_std,
    fea_store_unique_items,
    fea_state_price_avg,
    fea_state_price_min,
    fea_state_price_max,
    fea_state_price_std,
    fea_dept_price_avg,
    fea_dept_price_min,
    fea_dept_price_max,
    fea_dept_price_std,
    fea_dept_unique_items,
    fea_price_change_direction_1m,
    fea_price_pct_change_1m,
    fea_price_pct_change_3m,
    fea_price_pct_change_6m,
    fea_price_abs_change_1m,
    fea_price_abs_change_3m,
    fea_price_abs_change_6m,
    fea_item_vs_store_price_ratio,
    fea_item_vs_dept_price_ratio,
    fea_item_vs_state_price_ratio,
    fea_item_price_min_roll_avg_3_months,
    fea_item_price_min_roll_std_3_months,
    fea_item_price_min_roll_avg_6_months,
    fea_item_price_min_roll_std_6_months,
    fea_item_price_min_roll_avg_12_months,
    fea_item_price_min_roll_std_12_months,
    fea_item_price_max_roll_avg_3_months,
    fea_item_price_max_roll_std_3_months,
    fea_item_price_max_roll_avg_6_months,
    fea_item_price_max_roll_std_6_months,
    fea_item_price_max_roll_avg_12_months,
    fea_item_price_max_roll_std_12_months,
    fea_item_price_std_roll_avg_3_months,
    fea_item_price_std_roll_std_3_months,
    fea_item_price_std_roll_avg_6_months,
    fea_item_price_std_roll_std_6_months,
    fea_item_price_std_roll_avg_12_months,
    fea_item_price_std_roll_std_12_months,
    fea_item_price_avg_roll_avg_3_months,
    fea_item_price_avg_roll_std_3_months,
    fea_item_price_avg_roll_avg_6_months,
    fea_item_price_avg_roll_std_6_months,
    fea_item_price_avg_roll_avg_12_months,
    fea_item_price_avg_roll_std_12_months,
    fea_item_store_price_min_roll_avg_3_months,
    fea_item_store_price_min_roll_std_3_months,
    fea_item_store_price_min_roll_avg_6_months,
    fea_item_store_price_min_roll_std_6_months,
    fea_item_store_price_min_roll_avg_12_months,
    fea_item_store_price_min_roll_std_12_months,
    fea_item_store_price_max_roll_avg_3_months,
    fea_item_store_price_max_roll_std_3_months,
    fea_item_store_price_max_roll_avg_6_months,
    fea_item_store_price_max_roll_std_6_months,
    fea_item_store_price_max_roll_avg_12_months,
    fea_item_store_price_max_roll_std_12_months,
    fea_item_store_price_std_roll_avg_3_months,
    fea_item_store_price_std_roll_std_3_months,
    fea_item_store_price_std_roll_avg_6_months,
    fea_item_store_price_std_roll_std_6_months,
    fea_item_store_price_std_roll_avg_12_months,
    fea_item_store_price_std_roll_std_12_months,
    fea_item_store_price_avg_roll_avg_3_months,
    fea_item_store_price_avg_roll_std_3_months,
    fea_item_store_price_avg_roll_avg_6_months,
    fea_item_store_price_avg_roll_std_6_months,
    fea_item_store_price_avg_roll_avg_12_months,
    fea_item_store_price_avg_roll_std_12_months,
    fea_store_price_avg_roll_avg_3_months,
    fea_store_price_avg_roll_std_3_months,
    fea_store_price_avg_roll_avg_6_months,
    fea_store_price_avg_roll_std_6_months,
    fea_store_price_avg_roll_avg_12_months,
    fea_store_price_avg_roll_std_12_months,
    fea_store_price_std_roll_avg_3_months,
    fea_store_price_std_roll_std_3_months,
    fea_store_price_std_roll_avg_6_months,
    fea_store_price_std_roll_std_6_months,
    fea_store_price_std_roll_avg_12_months,
    fea_store_price_std_roll_std_12_months,
    fea_store_unique_items_roll_avg_3_months,
    fea_store_unique_items_roll_std_3_months,
    fea_store_unique_items_roll_avg_6_months,
    fea_store_unique_items_roll_std_6_months,
    fea_store_unique_items_roll_avg_12_months,
    fea_store_unique_items_roll_std_12_months,
    fea_dept_price_avg_roll_avg_3_months,
    fea_dept_price_avg_roll_std_3_months,
    fea_dept_price_avg_roll_avg_6_months,
    fea_dept_price_avg_roll_std_6_months,
    fea_dept_price_avg_roll_avg_12_months,
    fea_dept_price_avg_roll_std_12_months,
    fea_dept_price_std_roll_avg_3_months,
    fea_dept_price_std_roll_std_3_months,
    fea_dept_price_std_roll_avg_6_months,
    fea_dept_price_std_roll_std_6_months,
    fea_dept_price_std_roll_avg_12_months,
    fea_dept_price_std_roll_std_12_months,
    fea_dept_price_min_roll_avg_3_months,
    fea_dept_price_min_roll_std_3_months,
    fea_dept_price_min_roll_avg_6_months,
    fea_dept_price_min_roll_std_6_months,
    fea_dept_price_min_roll_avg_12_months,
    fea_dept_price_min_roll_std_12_months,
    fea_dept_price_max_roll_avg_3_months,
    fea_dept_price_max_roll_std_3_months,
    fea_dept_price_max_roll_avg_6_months,
    fea_dept_price_max_roll_std_6_months,
    fea_dept_price_max_roll_avg_12_months,
    fea_dept_price_max_roll_std_12_months,
    fea_dept_unique_items_roll_avg_3_months,
    fea_dept_unique_items_roll_std_3_months,
    fea_dept_unique_items_roll_avg_6_months,
    fea_dept_unique_items_roll_std_6_months,
    fea_dept_unique_items_roll_avg_12_months,
    fea_dept_unique_items_roll_std_12_months,
    fea_state_price_avg_roll_avg_3_months,
    fea_state_price_avg_roll_std_3_months,
    fea_state_price_avg_roll_avg_6_months,
    fea_state_price_avg_roll_std_6_months,
    fea_state_price_avg_roll_avg_12_months,
    fea_state_price_avg_roll_std_12_months,
    fea_state_price_std_roll_avg_3_months,
    fea_state_price_std_roll_std_3_months,
    fea_state_price_std_roll_avg_6_months,
    fea_state_price_std_roll_std_6_months,
    fea_state_price_std_roll_avg_12_months,
    fea_state_price_std_roll_std_12_months,
    fea_item_vs_store_price_ratio_roll_avg_3_months,
    fea_item_vs_store_price_ratio_roll_std_3_months,
    fea_item_vs_store_price_ratio_roll_avg_6_months,
    fea_item_vs_store_price_ratio_roll_std_6_months,
    fea_item_vs_store_price_ratio_roll_avg_12_months,
    fea_item_vs_store_price_ratio_roll_std_12_months,
    fea_item_vs_dept_price_ratio_roll_avg_3_months,
    fea_item_vs_dept_price_ratio_roll_std_3_months,
    fea_item_vs_dept_price_ratio_roll_avg_6_months,
    fea_item_vs_dept_price_ratio_roll_std_6_months,
    fea_item_vs_dept_price_ratio_roll_avg_12_months,
    fea_item_vs_dept_price_ratio_roll_std_12_months,
    fea_item_vs_state_price_ratio_roll_avg_3_months,
    fea_item_vs_state_price_ratio_roll_std_3_months,
    fea_item_vs_state_price_ratio_roll_avg_6_months,
    fea_item_vs_state_price_ratio_roll_std_6_months,
    fea_item_vs_state_price_ratio_roll_avg_12_months,
    fea_item_vs_state_price_ratio_roll_std_12_months,
    fea_item_monthly_sales,
    fea_num_days_item_is_zero_sales,
    fea_item_monthly_sales_roll_avg_3_months,
    fea_item_monthly_sales_roll_avg_6_months,
    fea_item_monthly_sales_roll_avg_12_months,
    fea_item_monthly_sales_roll_std_3_months,
    fea_item_monthly_sales_roll_std_6_months,
    fea_item_monthly_sales_roll_std_12_months,
    fea_item_monthly_sales_lag_1_months,
    fea_item_monthly_sales_lag_2_months,
    fea_item_monthly_sales_lag_3_months,
    fea_item_monthly_sales_lag_4_months,
    fea_num_days_item_is_zero_sales_roll_avg_3_months,
    fea_num_days_item_is_zero_sales_roll_avg_6_months,
    fea_num_days_item_is_zero_sales_roll_avg_12_months,
    fea_num_days_item_is_zero_sales_roll_std_3_months,
    fea_num_days_item_is_zero_sales_roll_std_6_months,
    fea_num_days_item_is_zero_sales_roll_std_12_months,
    fea_num_days_item_is_zero_sales_lag_1_months,
    fea_num_days_item_is_zero_sales_lag_2_months,
    fea_num_days_item_is_zero_sales_lag_3_months,
    fea_num_days_item_is_zero_sales_lag_4_months,
    fea_state_item_monthly_sales,
    fea_state_item_num_days_is_zero_sales,
    fea_state_item_monthly_sales_roll_avg_3_months,
    fea_state_item_monthly_sales_roll_avg_6_months,
    fea_state_item_monthly_sales_roll_avg_12_months,
    fea_state_item_monthly_sales_roll_std_3_months,
    fea_state_item_monthly_sales_roll_std_6_months,
    fea_state_item_monthly_sales_roll_std_12_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_3_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_6_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_12_months,
    fea_state_item_num_days_is_zero_sales_roll_std_3_months,
    fea_state_item_num_days_is_zero_sales_roll_std_6_months,
    fea_state_item_num_days_is_zero_sales_roll_std_12_months,
    fea_all_item_monthly_sales,
    fea_all_item_num_days_is_zero_sales,
    fea_all_item_monthly_sales_roll_avg_3_months,
    fea_all_item_monthly_sales_roll_avg_6_months,
    fea_all_item_monthly_sales_roll_avg_12_months,
    fea_all_item_monthly_sales_roll_std_3_months,
    fea_all_item_monthly_sales_roll_std_6_months,
    fea_all_item_monthly_sales_roll_std_12_months
FROM ${ref("target_store_item_monthly")} tgt
JOIN ${ref("stockout_filter")} sf
    ON sf.ctx_date_month = tgt.ctx_date_month
    AND sf.ctx_item_id = tgt.ctx_item_id
    AND sf.ctx_store_id = tgt.ctx_store_id
LEFT JOIN ${ref("calendar_features")} cal
    ON cal.ctx_date_month = tgt.ctx_date_month
LEFT JOIN ${ref("global_rolling_sales_features")} glob_feas
    ON glob_feas.ctx_date_month = tgt.ctx_date_month
LEFT JOIN ${ref("rolling_sales_features")} roll_feas
    ON roll_feas.ctx_date_month = tgt.ctx_date_month
    AND roll_feas.ctx_item_id = tgt.ctx_item_id
    AND roll_feas.ctx_store_id = tgt.ctx_store_id
LEFT JOIN ${ref("price_features_ts")} price_features
    ON price_features.ctx_date_month = tgt.ctx_date_month
    AND price_features.ctx_item_id = tgt.ctx_item_id
    AND price_features.ctx_store_id = tgt.ctx_store_id
