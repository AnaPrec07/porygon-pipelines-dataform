CREATE OR REPLACE TABLE `porygon-pipelines.walmart_training_tables.training_table_v8` AS (
  SELECT 
    -- context fields
    tgt.ctx_date_month,
    tgt.ctx_cat_id,
    tgt.ctx_dept_id,
    tgt.ctx_item_id,
    tgt.ctx_state_id,
    tgt.ctx_store_id,

    -- target fields
    tgt_monthly_sales,
    tgt_days_is_zero_sales,
    tgt_monthly_sales_sum_3_next_months,

    -- calendar feature fields
    fea_is_weekend,
    fea_is_event_1,
    fea_is_event_2,
    fea_is_sporting_event,
    fea_is_cultural_event,
    fea_is_national_event,
    fea_is_religious_event,
    fea_is_snap_ca,
    fea_is_snap_tx,
    fea_is_snap_wi,
    fea_month_sin,
    fea_detrender,

    -- price price_features
    fea_item_price_avg,
    fea_item_price_min,
    fea_item_price_max,
    fea_item_price_std,
    fea_store_price_avg,
    fea_store_price_min,
    fea_store_price_max,
    fea_store_price_std,
    fea_store_unique_items,
    fea_state_price_avg,
    fea_state_price_min,
    fea_state_price_max,
    fea_state_price_std,
    fea_dept_price_avg,
    fea_dept_price_min,
    fea_dept_price_max,
    fea_dept_price_std,
    fea_dept_unique_items,
    fea_price_pct_change_1m,
    fea_price_pct_change_3m,
    fea_price_pct_change_6m,
    fea_price_abs_change_1m,
    fea_price_abs_change_3m,
    fea_price_abs_change_6m,
    fea_item_vs_store_price_ratio,
    fea_item_vs_dept_price_ratio,
    fea_item_vs_state_price_ratio,
    fea_item_price_min_roll_avg_3_months,
    fea_item_price_min_roll_std_3_months,
    fea_item_price_min_roll_avg_6_months,
    fea_item_price_min_roll_std_6_months,
    fea_item_price_min_roll_avg_12_months,
    fea_item_price_min_roll_std_12_months,
    fea_item_price_max_roll_avg_3_months,
    fea_item_price_max_roll_std_3_months,
    fea_item_price_max_roll_avg_6_months,
    fea_item_price_max_roll_std_6_months,
    fea_item_price_max_roll_avg_12_months,
    fea_item_price_max_roll_std_12_months,
    fea_item_price_std_roll_avg_3_months,
    fea_item_price_std_roll_std_3_months,
    fea_item_price_std_roll_avg_6_months,
    fea_item_price_std_roll_std_6_months,
    fea_item_price_std_roll_avg_12_months,
    fea_item_price_std_roll_std_12_months,
    fea_item_price_avg_roll_avg_3_months,
    fea_item_price_avg_roll_std_3_months,
    fea_item_price_avg_roll_avg_6_months,
    fea_item_price_avg_roll_std_6_months,
    fea_item_price_avg_roll_avg_12_months,
    fea_item_price_avg_roll_std_12_months,
    fea_item_store_price_min_roll_avg_3_months,
    fea_item_store_price_min_roll_std_3_months,
    fea_item_store_price_min_roll_avg_6_months,
    fea_item_store_price_min_roll_std_6_months,
    fea_item_store_price_min_roll_avg_12_months,
    fea_item_store_price_min_roll_std_12_months,
    fea_item_store_price_max_roll_avg_3_months,
    fea_item_store_price_max_roll_std_3_months,
    fea_item_store_price_max_roll_avg_6_months,
    fea_item_store_price_max_roll_std_6_months,
    fea_item_store_price_max_roll_avg_12_months,
    fea_item_store_price_max_roll_std_12_months,
    fea_item_store_price_std_roll_avg_3_months,
    fea_item_store_price_std_roll_std_3_months,
    fea_item_store_price_std_roll_avg_6_months,
    fea_item_store_price_std_roll_std_6_months,
    fea_item_store_price_std_roll_avg_12_months,
    fea_item_store_price_std_roll_std_12_months,
    fea_item_store_price_avg_roll_avg_3_months,
    fea_item_store_price_avg_roll_std_3_months,
    fea_item_store_price_avg_roll_avg_6_months,
    fea_item_store_price_avg_roll_std_6_months,
    fea_item_store_price_avg_roll_avg_12_months,
    fea_item_store_price_avg_roll_std_12_months,
    fea_store_price_avg_roll_avg_3_months,
    fea_store_price_avg_roll_std_3_months,
    fea_store_price_avg_roll_avg_6_months,
    fea_store_price_avg_roll_std_6_months,
    fea_store_price_avg_roll_avg_12_months,
    fea_store_price_avg_roll_std_12_months,
    fea_store_price_std_roll_avg_3_months,
    fea_store_price_std_roll_std_3_months,
    fea_store_price_std_roll_avg_6_months,
    fea_store_price_std_roll_std_6_months,
    fea_store_price_std_roll_avg_12_months,
    fea_store_price_std_roll_std_12_months,
    fea_store_unique_items_roll_avg_3_months,
    fea_store_unique_items_roll_std_3_months,
    fea_store_unique_items_roll_avg_6_months,
    fea_store_unique_items_roll_std_6_months,
    fea_store_unique_items_roll_avg_12_months,
    fea_store_unique_items_roll_std_12_months,
    fea_dept_price_avg_roll_avg_3_months,
    fea_dept_price_avg_roll_std_3_months,
    fea_dept_price_avg_roll_avg_6_months,
    fea_dept_price_avg_roll_std_6_months,
    fea_dept_price_avg_roll_avg_12_months,
    fea_dept_price_avg_roll_std_12_months,
    fea_dept_price_std_roll_avg_3_months,
    fea_dept_price_std_roll_std_3_months,
    fea_dept_price_std_roll_avg_6_months,
    fea_dept_price_std_roll_std_6_months,
    fea_dept_price_std_roll_avg_12_months,
    fea_dept_price_std_roll_std_12_months,
    fea_dept_price_min_roll_avg_3_months,
    fea_dept_price_min_roll_std_3_months,
    fea_dept_price_min_roll_avg_6_months,
    fea_dept_price_min_roll_std_6_months,
    fea_dept_price_min_roll_avg_12_months,
    fea_dept_price_min_roll_std_12_months,
    fea_dept_price_max_roll_avg_3_months,
    fea_dept_price_max_roll_std_3_months,
    fea_dept_price_max_roll_avg_6_months,
    fea_dept_price_max_roll_std_6_months,
    fea_dept_price_max_roll_avg_12_months,
    fea_dept_price_max_roll_std_12_months,
    fea_dept_unique_items_roll_avg_3_months,
    fea_dept_unique_items_roll_std_3_months,
    fea_dept_unique_items_roll_avg_6_months,
    fea_dept_unique_items_roll_std_6_months,
    fea_dept_unique_items_roll_avg_12_months,
    fea_dept_unique_items_roll_std_12_months,
    fea_state_price_avg_roll_avg_3_months,
    fea_state_price_avg_roll_std_3_months,
    fea_state_price_avg_roll_avg_6_months,
    fea_state_price_avg_roll_std_6_months,
    fea_state_price_avg_roll_avg_12_months,
    fea_state_price_avg_roll_std_12_months,
    fea_state_price_std_roll_avg_3_months,
    fea_state_price_std_roll_std_3_months,
    fea_state_price_std_roll_avg_6_months,
    fea_state_price_std_roll_std_6_months,
    fea_state_price_std_roll_avg_12_months,
    fea_state_price_std_roll_std_12_months,
    fea_item_vs_store_price_ratio_roll_avg_3_months,
    fea_item_vs_store_price_ratio_roll_std_3_months,
    fea_item_vs_store_price_ratio_roll_avg_6_months,
    fea_item_vs_store_price_ratio_roll_std_6_months,
    fea_item_vs_store_price_ratio_roll_avg_12_months,
    fea_item_vs_store_price_ratio_roll_std_12_months,
    fea_item_vs_dept_price_ratio_roll_avg_3_months,
    fea_item_vs_dept_price_ratio_roll_std_3_months,
    fea_item_vs_dept_price_ratio_roll_avg_6_months,
    fea_item_vs_dept_price_ratio_roll_std_6_months,
    fea_item_vs_dept_price_ratio_roll_avg_12_months,
    fea_item_vs_dept_price_ratio_roll_std_12_months,
    fea_item_vs_state_price_ratio_roll_avg_3_months,
    fea_item_vs_state_price_ratio_roll_std_3_months,
    fea_item_vs_state_price_ratio_roll_avg_6_months,
    fea_item_vs_state_price_ratio_roll_std_6_months,
    fea_item_vs_state_price_ratio_roll_avg_12_months,
    fea_item_vs_state_price_ratio_roll_std_12_months,

    -- encoded features
    fea_state_id_encoded,
    fea_cat_id_encoded,
    fea_dept_id_encoded,
    fea_store_id_encoded,
    fea_item_id_encoded,

    -- weather features
    mean_temperature,
    mean_dewp,
    mean_visib,
    mean_wdsp,
    mean_prcp,
    mean_sndp,
    mean_gust,
    mean_fog,
    mean_tornado_funnel_cloud,
    mean_thunder,
    mean_snow_ice_pellets,
    mean_rain_drizzle,
    min_temperature,
    min_dewp,
    min_visib,
    min_wdsp,
    min_prcp,
    min_sndp,
    min_gust,
    min_fog,
    min_tornado_funnel_cloud,
    min_thunder,
    min_snow_ice_pellets,
    min_rain_drizzle,
    max_temperature,
    max_dewp,
    max_visib,
    max_wdsp,
    max_prcp,
    max_sndp,
    max_gust,
    max_fog,
    max_tornado_funnel_cloud,
    max_thunder,
    max_snow_ice_pellets,
    max_rain_drizzle,
    std_temperature,
    std_dewp,
    std_visib,
    std_wdsp,
    std_prcp,
    std_sndp,
    std_gust,
    std_fog,
    std_tornado_funnel_cloud,
    std_thunder,
    std_snow_ice_pellets,
    std_rain_drizzle,
    mean_temperature_roll_avg_3_months,
    mean_temperature_roll_std_3_months,
    mean_temperature_roll_avg_6_months,
    mean_temperature_roll_std_6_months,
    mean_temperature_roll_avg_12_months,
    mean_temperature_roll_std_12_months,
    mean_dewp_roll_avg_3_months,
    mean_dewp_roll_std_3_months,
    mean_dewp_roll_avg_6_months,
    mean_dewp_roll_std_6_months,
    mean_dewp_roll_avg_12_months,
    mean_dewp_roll_std_12_months,
    mean_visib_roll_avg_3_months,
    mean_visib_roll_std_3_months,
    mean_visib_roll_avg_6_months,
    mean_visib_roll_std_6_months,
    mean_visib_roll_avg_12_months,
    mean_visib_roll_std_12_months,
    mean_wdsp_roll_avg_3_months,
    mean_wdsp_roll_std_3_months,
    mean_wdsp_roll_avg_6_months,
    mean_wdsp_roll_std_6_months,
    mean_wdsp_roll_avg_12_months,
    mean_wdsp_roll_std_12_months,
    mean_prcp_roll_avg_3_months,
    mean_prcp_roll_std_3_months,
    mean_prcp_roll_avg_6_months,
    mean_prcp_roll_std_6_months,
    mean_prcp_roll_avg_12_months,
    mean_prcp_roll_std_12_months,
    mean_sndp_roll_avg_3_months,
    mean_sndp_roll_std_3_months,
    mean_sndp_roll_avg_6_months,
    mean_sndp_roll_std_6_months,
    mean_sndp_roll_avg_12_months,
    mean_sndp_roll_std_12_months,
    mean_gust_roll_avg_3_months,
    mean_gust_roll_std_3_months,
    mean_gust_roll_avg_6_months,
    mean_gust_roll_std_6_months,
    mean_gust_roll_avg_12_months,
    mean_gust_roll_std_12_months,
    mean_tornado_funnel_cloud_roll_avg_3_months,
    mean_tornado_funnel_cloud_roll_std_3_months,
    mean_tornado_funnel_cloud_roll_avg_6_months,
    mean_tornado_funnel_cloud_roll_std_6_months,
    mean_tornado_funnel_cloud_roll_avg_12_months,
    mean_tornado_funnel_cloud_roll_std_12_months,
    mean_thunder_roll_avg_3_months,
    mean_thunder_roll_std_3_months,
    mean_thunder_roll_avg_6_months,
    mean_thunder_roll_std_6_months,
    mean_thunder_roll_avg_12_months,
    mean_thunder_roll_std_12_months,
    mean_snow_ice_pellets_roll_avg_3_months,
    mean_snow_ice_pellets_roll_std_3_months,
    mean_snow_ice_pellets_roll_avg_6_months,
    mean_snow_ice_pellets_roll_std_6_months,
    mean_snow_ice_pellets_roll_avg_12_months,
    mean_snow_ice_pellets_roll_std_12_months,
    mean_rain_drizzle_roll_avg_3_months,
    mean_rain_drizzle_roll_std_3_months,
    mean_rain_drizzle_roll_avg_6_months,
    mean_rain_drizzle_roll_std_6_months,
    mean_rain_drizzle_roll_avg_12_months,
    mean_rain_drizzle_roll_std_12_months,

    -- demographic cencus features
    fea_nonfamily_households,
    fea_family_households,
    fea_total_pop,
    fea_commuters_by_public_transportation,
    fea_median_income,
    fea_income_per_capita,
    fea_vacant_housing_units,
    fea_median_rent,
    fea_percent_income_spent_on_rent,
    fea_median_age,
    fea_families_with_young_children,
    fea_commute_10_14_mins,
    fea_commute_25_29_mins,
    fea_commute_45_59_mins,
    fea_income_20000_24999,
    fea_income_40000_44999,
    fea_income_60000_74999,
    fea_income_150000_199999,
    fea_households_retirement_income,
    fea_employed_pop,
    fea_unemployed_pop,
    fea_four_more_cars,
    fea_bachelors_degree_or_higher_25_64,
    fea_gini_index,
    fea_in_school,
    fea_in_undergrad_college,

    -- economic indicator features
    fea_wi_unemployment_rate,
    fea_tx_unemployment_rate,
    fea_ca_unemployment_rate,
    fea_gas_price_per_gallon,
    fea_wi_unemployment_rate_roll_avg_3_months,
    fea_wi_unemployment_rate_roll_std_3_months,
    fea_wi_unemployment_rate_roll_avg_6_months,
    fea_wi_unemployment_rate_roll_std_6_months,
    fea_wi_unemployment_rate_roll_avg_12_months,
    fea_wi_unemployment_rate_roll_std_12_months,
    fea_tx_unemployment_rate_roll_avg_3_months,
    fea_tx_unemployment_rate_roll_std_3_months,
    fea_tx_unemployment_rate_roll_avg_6_months,
    fea_tx_unemployment_rate_roll_std_6_months,
    fea_tx_unemployment_rate_roll_avg_12_months,
    fea_tx_unemployment_rate_roll_std_12_months,
    fea_ca_unemployment_rate_roll_avg_3_months,
    fea_ca_unemployment_rate_roll_std_3_months,
    fea_ca_unemployment_rate_roll_avg_6_months,
    fea_ca_unemployment_rate_roll_std_6_months,
    fea_ca_unemployment_rate_roll_avg_12_months,
    fea_ca_unemployment_rate_roll_std_12_months,
    fea_gas_price_per_gallon_roll_avg_3_months,
    fea_gas_price_per_gallon_roll_std_3_months,
    fea_gas_price_per_gallon_roll_avg_6_months,
    fea_gas_price_per_gallon_roll_std_6_months,
    fea_gas_price_per_gallon_roll_avg_12_months,
    fea_gas_price_per_gallon_roll_std_12_months,

    -- monthly sales delta features
    fea_ca_monthly_sales_delta,
    fea_tx_monthly_sales_delta,
    fea_wi_monthly_sales_delta,
    fea_hobbies_monthly_sales_delta,
    fea_household_monthly_sales_delta,
    fea_foods_monthly_sales_delta,
    fea_hobbies_1_monthly_sales_delta,
    fea_hobbies_2_monthly_sales_delta,
    fea_household_1_monthly_sales_delta,
    fea_household_2_monthly_sales_delta,
    fea_foods_1_monthly_sales_delta,
    fea_foods_2_monthly_sales_delta,
    fea_foods_3_monthly_sales_delta,
    fea_ca_1_monthly_sales_delta,
    fea_ca_2_monthly_sales_delta,
    fea_ca_3_monthly_sales_delta,
    fea_ca_4_monthly_sales_delta,
    fea_tx_1_monthly_sales_delta,
    fea_tx_2_monthly_sales_delta,
    fea_tx_3_monthly_sales_delta,
    fea_wi_1_monthly_sales_delta,
    fea_wi_2_monthly_sales_delta,
    fea_wi_3_monthly_sales_delta,
    fea_ca_monthly_sales_delta_roll_avg_3_months,
    fea_ca_monthly_sales_delta_roll_std_3_months,
    fea_ca_monthly_sales_delta_roll_avg_6_months,
    fea_ca_monthly_sales_delta_roll_std_6_months,
    fea_ca_monthly_sales_delta_roll_avg_12_months,
    fea_ca_monthly_sales_delta_roll_std_12_months,
    fea_tx_monthly_sales_delta_roll_avg_3_months,
    fea_tx_monthly_sales_delta_roll_std_3_months,
    fea_tx_monthly_sales_delta_roll_avg_6_months,
    fea_tx_monthly_sales_delta_roll_std_6_months,
    fea_tx_monthly_sales_delta_roll_avg_12_months,
    fea_tx_monthly_sales_delta_roll_std_12_months,
    fea_wi_monthly_sales_delta_roll_avg_3_months,
    fea_wi_monthly_sales_delta_roll_std_3_months,
    fea_wi_monthly_sales_delta_roll_avg_6_months,
    fea_wi_monthly_sales_delta_roll_std_6_months,
    fea_wi_monthly_sales_delta_roll_avg_12_months,
    fea_wi_monthly_sales_delta_roll_std_12_months,
    fea_hobbies_monthly_sales_delta_roll_avg_3_months,
    fea_hobbies_monthly_sales_delta_roll_std_3_months,
    fea_hobbies_monthly_sales_delta_roll_avg_6_months,
    fea_hobbies_monthly_sales_delta_roll_std_6_months,
    fea_hobbies_monthly_sales_delta_roll_avg_12_months,
    fea_hobbies_monthly_sales_delta_roll_std_12_months,
    fea_household_monthly_sales_delta_roll_avg_3_months,
    fea_household_monthly_sales_delta_roll_std_3_months,

    -- global monthly sales features
    fea_ca_monthly_sales_roll_avg_3_months,
    fea_ca_monthly_sales_roll_std_3_months,
    fea_ca_monthly_sales_roll_avg_6_months,
    fea_ca_monthly_sales_roll_std_6_months,
    fea_ca_monthly_sales_roll_avg_12_months,
    fea_ca_monthly_sales_roll_std_12_months,
    fea_tx_monthly_sales_roll_avg_3_months,
    fea_tx_monthly_sales_roll_std_3_months,
    fea_tx_monthly_sales_roll_avg_6_months,
    fea_tx_monthly_sales_roll_std_6_months,
    fea_tx_monthly_sales_roll_avg_12_months,
    fea_tx_monthly_sales_roll_std_12_months,
    fea_wi_monthly_sales_roll_avg_3_months,
    fea_wi_monthly_sales_roll_std_3_months,
    fea_wi_monthly_sales_roll_avg_6_months,
    fea_wi_monthly_sales_roll_std_6_months,
    fea_wi_monthly_sales_roll_avg_12_months,
    fea_wi_monthly_sales_roll_std_12_months,
    fea_hobbies_monthly_sales_roll_avg_3_months,
    fea_hobbies_monthly_sales_roll_std_3_months,
    fea_hobbies_monthly_sales_roll_avg_6_months,
    fea_hobbies_monthly_sales_roll_std_6_months,
    fea_hobbies_monthly_sales_roll_avg_12_months,
    fea_hobbies_monthly_sales_roll_std_12_months,
    fea_household_monthly_sales_roll_avg_3_months,
    fea_household_monthly_sales_roll_std_3_months,
    fea_household_monthly_sales_roll_avg_6_months,
    fea_household_monthly_sales_roll_std_6_months,
    fea_household_monthly_sales_roll_avg_12_months,
    fea_household_monthly_sales_roll_std_12_months,
    fea_foods_monthly_sales_roll_avg_3_months,
    fea_foods_monthly_sales_roll_std_3_months,
    fea_foods_monthly_sales_roll_avg_6_months,
    fea_foods_monthly_sales_roll_std_6_months,
    fea_foods_monthly_sales_roll_avg_12_months,
    fea_foods_monthly_sales_roll_std_12_months,
    fea_hobbies_1_monthly_sales_roll_avg_3_months,
    fea_hobbies_1_monthly_sales_roll_std_3_months,
    fea_hobbies_1_monthly_sales_roll_avg_6_months,
    fea_hobbies_1_monthly_sales_roll_std_6_months,
    fea_hobbies_1_monthly_sales_roll_avg_12_months,
    fea_hobbies_1_monthly_sales_roll_std_12_months,
    fea_hobbies_2_monthly_sales_roll_avg_3_months,
    fea_hobbies_2_monthly_sales_roll_std_3_months,
    fea_hobbies_2_monthly_sales_roll_avg_6_months,
    fea_hobbies_2_monthly_sales_roll_std_6_months,
    fea_hobbies_2_monthly_sales_roll_avg_12_months,
    fea_hobbies_2_monthly_sales_roll_std_12_months,
    fea_household_1_monthly_sales_roll_avg_3_months,
    fea_household_1_monthly_sales_roll_std_3_months,
    fea_household_1_monthly_sales_roll_avg_6_months,
    fea_household_1_monthly_sales_roll_std_6_months,
    fea_household_1_monthly_sales_roll_avg_12_months,
    fea_household_1_monthly_sales_roll_std_12_months,
    fea_household_2_monthly_sales_roll_avg_3_months,
    fea_household_2_monthly_sales_roll_std_3_months,
    fea_household_2_monthly_sales_roll_avg_6_months,
    fea_household_2_monthly_sales_roll_std_6_months,
    fea_household_2_monthly_sales_roll_avg_12_months,
    fea_household_2_monthly_sales_roll_std_12_months,
    fea_foods_1_monthly_sales_roll_avg_3_months,
    fea_foods_1_monthly_sales_roll_std_3_months,
    fea_foods_1_monthly_sales_roll_avg_6_months,
    fea_foods_1_monthly_sales_roll_std_6_months,
    fea_foods_1_monthly_sales_roll_avg_12_months,
    fea_foods_1_monthly_sales_roll_std_12_months,
    fea_foods_2_monthly_sales_roll_avg_3_months,
    fea_foods_2_monthly_sales_roll_std_3_months,
    fea_foods_2_monthly_sales_roll_avg_6_months,
    fea_foods_2_monthly_sales_roll_std_6_months,
    fea_foods_2_monthly_sales_roll_avg_12_months,
    fea_foods_2_monthly_sales_roll_std_12_months,
    fea_foods_3_monthly_sales_roll_avg_3_months,
    fea_foods_3_monthly_sales_roll_std_3_months,
    fea_foods_3_monthly_sales_roll_avg_6_months,
    fea_foods_3_monthly_sales_roll_std_6_months,
    fea_foods_3_monthly_sales_roll_avg_12_months,
    fea_foods_3_monthly_sales_roll_std_12_months,
    fea_ca_1_monthly_sales_roll_avg_3_months,
    fea_ca_1_monthly_sales_roll_std_3_months,
    fea_ca_1_monthly_sales_roll_avg_6_months,
    fea_ca_1_monthly_sales_roll_std_6_months,
    fea_ca_1_monthly_sales_roll_avg_12_months,
    fea_ca_1_monthly_sales_roll_std_12_months,
    fea_ca_2_monthly_sales_roll_avg_3_months,
    fea_ca_2_monthly_sales_roll_std_3_months,
    fea_ca_2_monthly_sales_roll_avg_6_months,
    fea_ca_2_monthly_sales_roll_std_6_months,
    fea_ca_2_monthly_sales_roll_avg_12_months,
    fea_ca_2_monthly_sales_roll_std_12_months,
    fea_ca_3_monthly_sales_roll_avg_3_months,
    fea_ca_3_monthly_sales_roll_std_3_months,
    fea_ca_3_monthly_sales_roll_avg_6_months,
    fea_ca_3_monthly_sales_roll_std_6_months,
    fea_ca_3_monthly_sales_roll_avg_12_months,
    fea_ca_3_monthly_sales_roll_std_12_months,
    fea_ca_4_monthly_sales_roll_avg_3_months,
    fea_ca_4_monthly_sales_roll_std_3_months,
    fea_ca_4_monthly_sales_roll_avg_6_months,
    fea_ca_4_monthly_sales_roll_std_6_months,
    fea_ca_4_monthly_sales_roll_avg_12_months,
    fea_ca_4_monthly_sales_roll_std_12_months,
    fea_tx_1_monthly_sales_roll_avg_3_months,
    fea_tx_1_monthly_sales_roll_std_3_months,
    fea_tx_1_monthly_sales_roll_avg_6_months,
    fea_tx_1_monthly_sales_roll_std_6_months,
    fea_tx_1_monthly_sales_roll_avg_12_months,
    fea_tx_1_monthly_sales_roll_std_12_months,
    fea_tx_2_monthly_sales_roll_avg_3_months,
    fea_tx_2_monthly_sales_roll_std_3_months,
    fea_tx_2_monthly_sales_roll_avg_6_months,
    fea_tx_2_monthly_sales_roll_std_6_months,
    fea_tx_2_monthly_sales_roll_avg_12_months,
    fea_tx_2_monthly_sales_roll_std_12_months,
    fea_tx_3_monthly_sales_roll_avg_3_months,
    fea_tx_3_monthly_sales_roll_std_3_months,
    fea_tx_3_monthly_sales_roll_avg_6_months,
    fea_tx_3_monthly_sales_roll_std_6_months,
    fea_tx_3_monthly_sales_roll_avg_12_months,
    fea_tx_3_monthly_sales_roll_std_12_months,
    fea_wi_1_monthly_sales_roll_avg_3_months,
    fea_wi_1_monthly_sales_roll_std_3_months,
    fea_wi_1_monthly_sales_roll_avg_6_months,
    fea_wi_1_monthly_sales_roll_std_6_months,
    fea_wi_1_monthly_sales_roll_avg_12_months,
    fea_wi_1_monthly_sales_roll_std_12_months,
    fea_wi_2_monthly_sales_roll_avg_3_months,
    fea_wi_2_monthly_sales_roll_std_3_months,
    fea_wi_2_monthly_sales_roll_avg_6_months,
    fea_wi_2_monthly_sales_roll_std_6_months,
    fea_wi_2_monthly_sales_roll_avg_12_months,
    fea_wi_2_monthly_sales_roll_std_12_months,
    fea_wi_3_monthly_sales_roll_avg_3_months,
    fea_wi_3_monthly_sales_roll_std_3_months,
    fea_wi_3_monthly_sales_roll_avg_6_months,
    fea_wi_3_monthly_sales_roll_std_6_months,
    fea_wi_3_monthly_sales_roll_avg_12_months,
    fea_wi_3_monthly_sales_roll_std_12_months,

    ---- item sales features
    fea_item_monthly_sales,
    fea_num_days_item_is_zero_sales,
    fea_item_monthly_sales_roll_avg_3_months,
    fea_item_monthly_sales_roll_avg_6_months,
    fea_item_monthly_sales_roll_avg_12_months,
    fea_item_monthly_sales_roll_std_3_months,
    fea_item_monthly_sales_roll_std_6_months,
    fea_item_monthly_sales_roll_std_12_months,
    fea_item_monthly_sales_lag_1_months,
    fea_item_monthly_sales_lag_2_months,
    fea_item_monthly_sales_lag_3_months,
    fea_item_monthly_sales_lag_4_months,
    fea_num_days_item_is_zero_sales_roll_avg_3_months,
    fea_num_days_item_is_zero_sales_roll_avg_6_months,
    fea_num_days_item_is_zero_sales_roll_avg_12_months,
    fea_num_days_item_is_zero_sales_roll_std_3_months,
    fea_num_days_item_is_zero_sales_roll_std_6_months,
    fea_num_days_item_is_zero_sales_roll_std_12_months,
    fea_num_days_item_is_zero_sales_lag_1_months,
    fea_num_days_item_is_zero_sales_lag_2_months,
    fea_num_days_item_is_zero_sales_lag_3_months,
    fea_num_days_item_is_zero_sales_lag_4_months,
    fea_state_item_monthly_sales,
    fea_state_item_num_days_is_zero_sales,
    fea_state_item_monthly_sales_roll_avg_3_months,
    fea_state_item_monthly_sales_roll_avg_6_months,
    fea_state_item_monthly_sales_roll_avg_12_months,
    fea_state_item_monthly_sales_roll_std_3_months,
    fea_state_item_monthly_sales_roll_std_6_months,
    fea_state_item_monthly_sales_roll_std_12_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_3_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_6_months,
    fea_state_item_num_days_is_zero_sales_roll_avg_12_months,
    fea_state_item_num_days_is_zero_sales_roll_std_3_months,
    fea_state_item_num_days_is_zero_sales_roll_std_6_months,
    fea_state_item_num_days_is_zero_sales_roll_std_12_months,
    fea_all_item_monthly_sales,
    fea_all_item_num_days_is_zero_sales,
    fea_all_item_monthly_sales_roll_avg_3_months,
    fea_all_item_monthly_sales_roll_avg_6_months,
    fea_all_item_monthly_sales_roll_avg_12_months,
    fea_all_item_monthly_sales_roll_std_3_months,
    fea_all_item_monthly_sales_roll_std_6_months,
    fea_all_item_monthly_sales_roll_std_12_months,

    -- individual item sales features
    fea_foods_2_013_monthly_sales,
    fea_foods_2_325_monthly_sales,
    fea_foods_3_226_monthly_sales,
    fea_foods_3_377_monthly_sales,
    fea_foods_2_030_monthly_sales,
    fea_hobbies_1_064_monthly_sales,
    fea_hobbies_1_381_monthly_sales,
    fea_hobbies_1_286_monthly_sales,
    fea_hobbies_2_009_monthly_sales,
    fea_foods_1_018_monthly_sales,
    fea_foods_3_042_monthly_sales,
    fea_foods_3_458_monthly_sales,
    fea_foods_3_672_monthly_sales,
    fea_foods_3_697_monthly_sales,
    fea_foods_3_734_monthly_sales,
    fea_household_1_027_monthly_sales,
    fea_household_1_319_monthly_sales,
    fea_household_1_118_monthly_sales,
    fea_hobbies_1_080_monthly_sales,
    fea_hobbies_1_004_monthly_sales,
    fea_hobbies_1_233_monthly_sales,
    fea_household_2_421_monthly_sales,
    fea_household_2_509_monthly_sales,
    fea_household_2_287_monthly_sales,
    fea_household_2_140_monthly_sales,
    fea_household_2_417_monthly_sales,
    fea_household_2_135_monthly_sales,
    fea_household_2_145_monthly_sales,
    fea_household_2_395_monthly_sales,
    fea_hobbies_1_043_monthly_sales,
    fea_household_2_262_monthly_sales,
    fea_household_2_350_monthly_sales,
    fea_household_2_383_monthly_sales,
    fea_household_2_325_monthly_sales,
    fea_foods_2_342_monthly_sales,
    fea_foods_3_462_monthly_sales,
    fea_hobbies_1_249_monthly_sales,
    fea_household_2_447_monthly_sales,
    fea_household_2_159_monthly_sales,
    fea_foods_2_347_monthly_sales,
    fea_foods_2_384_monthly_sales,
    fea_foods_3_080_monthly_sales,
    fea_foods_3_202_monthly_sales,
    fea_foods_3_503_monthly_sales,
    fea_foods_3_555_monthly_sales,
    fea_foods_3_756_monthly_sales,
    fea_household_1_072_monthly_sales,
    fea_foods_2_063_monthly_sales,
    fea_foods_2_374_monthly_sales,
    fea_hobbies_1_295_monthly_sales,
    fea_household_1_114_monthly_sales,
    fea_household_1_294_monthly_sales,
    fea_household_1_478_monthly_sales,
    fea_foods_1_170_monthly_sales,
    fea_foods_2_236_monthly_sales,
    fea_foods_3_704_monthly_sales,
    fea_hobbies_1_089_monthly_sales,
    fea_hobbies_1_379_monthly_sales,
    fea_hobbies_1_201_monthly_sales,
    fea_hobbies_1_323_monthly_sales,
    fea_household_2_037_monthly_sales,
    fea_household_2_348_monthly_sales,
    fea_household_2_197_monthly_sales,
    fea_household_2_442_monthly_sales,
    fea_household_2_084_monthly_sales,
    fea_household_2_160_monthly_sales,
    fea_household_2_315_monthly_sales,
    fea_household_2_437_monthly_sales,
    fea_foods_1_085_monthly_sales,
    fea_foods_2_299_monthly_sales,
    fea_foods_3_295_monthly_sales,
    fea_foods_3_389_monthly_sales,
    fea_foods_3_668_monthly_sales,
    fea_foods_3_694_monthly_sales,
    fea_foods_3_714_monthly_sales,
    fea_hobbies_1_134_monthly_sales,
    fea_hobbies_1_228_monthly_sales,
    fea_hobbies_1_254_monthly_sales,
    fea_household_2_483_monthly_sales,
    fea_hobbies_1_032_monthly_sales,
    fea_hobbies_1_209_monthly_sales,
    fea_hobbies_1_078_monthly_sales,
    fea_household_2_075_monthly_sales,
    fea_household_2_336_monthly_sales,
    fea_hobbies_1_073_monthly_sales,
    fea_household_2_341_monthly_sales,
    fea_household_2_054_monthly_sales,
    fea_foods_3_227_monthly_sales,
    fea_foods_3_516_monthly_sales,
    fea_foods_3_586_monthly_sales,
    fea_foods_3_407_monthly_sales,
    fea_household_1_109_monthly_sales,
    fea_foods_2_052_monthly_sales,
    fea_household_2_199_monthly_sales,
    fea_hobbies_1_415_monthly_sales,
    fea_household_2_047_monthly_sales,
    fea_household_2_512_monthly_sales,
    fea_foods_2_357_monthly_sales,
    fea_foods_1_087_monthly_sales,
    fea_foods_3_782_monthly_sales,
    fea_household_1_393_monthly_sales,
    fea_foods_2_054_monthly_sales,
    fea_foods_2_204_monthly_sales,
    fea_hobbies_1_074_monthly_sales,
    fea_hobbies_1_337_monthly_sales,
    fea_household_1_247_monthly_sales,
    fea_household_1_516_monthly_sales,
    fea_foods_2_293_monthly_sales,
    fea_hobbies_1_029_monthly_sales,
    fea_hobbies_1_416_monthly_sales,
    fea_hobbies_1_108_monthly_sales,
    fea_hobbies_1_345_monthly_sales,
    fea_hobbies_1_372_monthly_sales,
    fea_household_2_409_monthly_sales,
    fea_hobbies_1_235_monthly_sales,
    fea_household_2_427_monthly_sales,
    fea_hobbies_1_364_monthly_sales,
    fea_household_2_510_monthly_sales,
    fea_household_2_465_monthly_sales,
    fea_household_2_376_monthly_sales,
    fea_household_2_275_monthly_sales,
    fea_household_2_030_monthly_sales,
    fea_hobbies_2_003_monthly_sales,
    fea_foods_2_181_monthly_sales,
    fea_foods_3_744_monthly_sales,
    fea_foods_2_359_monthly_sales,
    fea_hobbies_1_016_monthly_sales,
    fea_household_2_212_monthly_sales,
    fea_foods_3_136_monthly_sales,
    fea_foods_3_252_monthly_sales,
    fea_household_1_494_monthly_sales,
    fea_household_1_198_monthly_sales,
    fea_household_1_196_monthly_sales,
    fea_household_1_243_monthly_sales,
    fea_foods_2_199_monthly_sales,
    fea_hobbies_1_179_monthly_sales,
    fea_household_2_295_monthly_sales,
    fea_foods_3_469_monthly_sales,
    fea_foods_3_501_monthly_sales,
    fea_hobbies_1_288_monthly_sales,
    fea_hobbies_1_147_monthly_sales,
    fea_hobbies_1_400_monthly_sales,
    fea_hobbies_2_103_monthly_sales,
    fea_foods_2_371_monthly_sales,
    fea_foods_3_099_monthly_sales,
    fea_foods_3_228_monthly_sales,
    fea_foods_3_477_monthly_sales,
    fea_foods_3_804_monthly_sales,
    fea_hobbies_1_330_monthly_sales,
    fea_foods_3_473_monthly_sales,
    fea_hobbies_1_103_monthly_sales,
    fea_hobbies_1_242_monthly_sales,
    fea_foods_2_164_monthly_sales,
    fea_household_2_201_monthly_sales,
    fea_hobbies_1_367_monthly_sales,
    fea_hobbies_1_329_monthly_sales,
    fea_household_2_453_monthly_sales,
    fea_household_2_222_monthly_sales,
    fea_hobbies_2_115_monthly_sales,
    fea_household_2_217_monthly_sales,
    fea_hobbies_2_096_monthly_sales,
    fea_foods_1_012_monthly_sales,
    fea_foods_1_161_monthly_sales,
    fea_foods_2_233_monthly_sales,
    fea_foods_3_178_monthly_sales,
    fea_foods_3_230_monthly_sales,
    fea_household_1_234_monthly_sales,
    fea_household_1_373_monthly_sales,
    fea_foods_1_096_monthly_sales,
    fea_hobbies_1_097_monthly_sales,
    fea_hobbies_1_319_monthly_sales,
    fea_household_2_438_monthly_sales,
    fea_hobbies_1_298_monthly_sales,
    fea_household_2_366_monthly_sales,
    fea_household_2_410_monthly_sales,
    fea_foods_3_654_monthly_sales,
    fea_foods_3_349_monthly_sales,
    fea_household_1_498_monthly_sales,
    fea_household_1_425_monthly_sales,
    fea_hobbies_1_320_monthly_sales,
    fea_household_1_251_monthly_sales,
    fea_household_2_368_monthly_sales,
    fea_hobbies_1_338_monthly_sales

FROM ${ref("target_store_item_monthly")} tgt
JOIN ${ref("stockout_filter")} sf
    ON sf.ctx_date_month = tgt.ctx_date_month
    AND sf.ctx_item_id = tgt.ctx_item_id
    AND sf.ctx_store_id = tgt.ctx_store_id
JOIN ${ref("target_outliers_filter")} tf
    ON tf.ctx_date_month = tgt.ctx_date_month
    AND tf.ctx_item_id = tgt.ctx_item_id
    AND tf.ctx_store_id = tgt.ctx_store_id
LEFT JOIN ${ref("calendar_features")} cal
    ON cal.ctx_date_month = tgt.ctx_date_month
LEFT JOIN ${ref("price_features_ts")} price_features
    ON price_features.ctx_date_month = tgt.ctx_date_month
    AND price_features.ctx_item_id = tgt.ctx_item_id
    AND price_features.ctx_store_id = tgt.ctx_store_id
LEFT JOIN ${ref("encoded_features")} enc
    ON enc.ctx_date_month = tgt.ctx_date_month
    AND enc.ctx_item_id = tgt.ctx_item_id
    AND enc.ctx_store_id = tgt.ctx_store_id
LEFT JOIN ${ref("weather_features")} wea_feas
    ON wea_feas.ctx_state_id = tgt.ctx_state_id
    AND wea_feas.ctx_date_month = tgt.ctx_date_month
LEFT JOIN ${ref("population_features")} pop_feas
    ON pop_feas.ctx_state_id = tgt.ctx_state_id
    AND ctx_date_year = EXTRACT(YEAR FROM tgt.ctx_date_month)
LEFT JOIN ${ref("economic_indicator_features")} econ_feas
    ON econ_feas.ctx_date_month = tgt.ctx_date_month
LEFT JOIN ${ref("rolling_percent_sales")} percent_feas
    ON percent_feas.ctx_date_month = tgt.ctx_date_month
LEFT JOIN ${ref("rolling_sales_features")} roll_feas
    ON roll_feas.ctx_date_month = tgt.ctx_date_month
    AND roll_feas.ctx_item_id = tgt.ctx_item_id
    AND roll_feas.ctx_store_id = tgt.ctx_store_id
LEFT JOIN ${ref("global_rolling_sales_features")} glob_feas
    ON glob_feas.ctx_date_month = tgt.ctx_date_month
LEFT JOIN ${ref("item_sales_features")} itfeas
    ON itfeas.ctx_date_month = tgt.ctx_date_month
    AND itfeas.ctx_dept_id = tgt.ctx_dept_id
    AND itfeas.ctx_store_id = tgt.ctx_store_id
WHERE tgt_days_is_zero_sales_lead_1_months <30
AND tgt_days_is_zero_sales_lead_2_months <30
AND tgt_days_is_zero_sales_lead_3_months <30
)