config {
  type: "table",
  schema: "walmart_training_tables",
  description: "walmart master table.",
  tags: ["intermediate", "master"]
}


  SELECT 
    -- context fields
    tgt.ctx_date_month,
    tgt.ctx_cat_id,
    tgt.ctx_dept_id,
    tgt.ctx_item_id,
    tgt.ctx_state_id,
    tgt.ctx_store_id,

    -- target fields
    tgt_monthly_sales,
    tgt_days_is_zero_sales,
    tgt_monthly_sales_sum_3_next_months,

    -- global features
    fea_item_monthly_sales,
    fea_item_monthly_sales_roll_avg_6_months,
    fea_item_monthly_sales_roll_avg_12_months,
    mean_dewp_roll_std_12_months,
    fea_wi_unemployment_rate_roll_std_6_months,
    fea_item_price_max_roll_std_12_months,
    fea_item_price_min_roll_avg_3_months,
    mean_rain_drizzle_roll_avg_12_months,
    fea_household_monthly_sales_roll_avg_12_months,
    fea_item_store_price_min_roll_avg_6_months,
    fea_item_store_price_std_roll_avg_3_months,
    fea_item_monthly_sales_roll_avg_3_months,
    fea_item_vs_dept_price_ratio_roll_std_12_months,
    fea_tx_monthly_sales_delta,
    fea_item_price_std_roll_std_6_months,
    fea_item_price_std_roll_std_12_months,
    fea_item_price_max_roll_avg_12_months,
    fea_ca_2_monthly_sales_roll_avg_12_months,
    mean_snow_ice_pellets_roll_avg_6_months,
    fea_gas_price_per_gallon_roll_avg_6_months,
    fea_tx_monthly_sales_delta_roll_avg_12_months,
    fea_foods_2_monthly_sales_delta,
    fea_household_1_monthly_sales_roll_avg_12_months,
    fea_foods_1_monthly_sales_delta,
    fea_store_price_std_roll_std_3_months,
    fea_ca_unemployment_rate_roll_std_6_months,
    fea_gas_price_per_gallon_roll_std_6_months,
    mean_gust,
    fea_ca_1_monthly_sales_roll_std_3_months,
    fea_num_days_item_is_zero_sales_lag_4_months,
    fea_wi_1_monthly_sales_roll_std_6_months,
    fea_tx_1_monthly_sales_delta,
    mean_visib_roll_std_6_months,
    fea_foods_monthly_sales_roll_std_3_months,
    fea_tx_monthly_sales_delta_roll_std_12_months,
    fea_foods_1_monthly_sales_roll_std_12_months,
    fea_item_price_std_roll_std_3_months,
    mean_sndp_roll_avg_12_months,
    fea_ca_4_monthly_sales_roll_std_3_months,
    fea_item_price_min_roll_std_3_months,
    fea_ca_1_monthly_sales_delta,
    fea_household_monthly_sales_roll_avg_3_months,
    mean_thunder_roll_std_6_months,
    fea_is_cultural_event,
    std_wdsp,
    mean_tornado_funnel_cloud,
    mean_prcp,
    fea_wi_1_monthly_sales_delta,
    fea_state_item_num_days_is_zero_sales_roll_avg_3_months,
    fea_tx_monthly_sales_delta_roll_std_3_months,

    -- it_feas
    fea_item_id_encoded,
    HOBBIES_1_089_roll_avg_3_months,
    HOUSEHOLD_2_426_roll_avg_3_months,
    FOODS_2_315_roll_std_3_months,
    FOODS_1_018_roll_avg_3_months,
    FOODS_1_046_roll_avg_3_months,
    HOBBIES_1_423_roll_std_3_months,
    HOBBIES_2_088_roll_std_3_months,
    HOUSEHOLD_2_287_roll_std_3_months,
    HOBBIES_1_228_roll_std_3_months,
    FOODS_2_131_roll_avg_3_months,
    HOUSEHOLD_2_212_roll_avg_3_months,
    HOUSEHOLD_2_070_roll_std_3_months,
    HOUSEHOLD_2_369_roll_std_3_months,
    HOBBIES_1_209_roll_std_3_months,
    HOBBIES_1_134_roll_avg_3_months,
    HOBBIES_1_037_roll_std_3_months,
    HOUSEHOLD_1_351_roll_std_3_months,
    HOUSEHOLD_2_199_roll_std_3_months,
    HOUSEHOLD_2_076_roll_avg_3_months,
    HOUSEHOLD_2_500_roll_avg_3_months,
    HOBBIES_1_323_roll_std_3_months,
    HOUSEHOLD_2_410_roll_std_3_months,
    HOBBIES_2_003_roll_avg_3_months,
    HOUSEHOLD_2_440_roll_avg_3_months,
    FOODS_3_080_roll_std_3_months,
    FOODS_2_299_roll_std_3_months,
    HOUSEHOLD_1_516_roll_std_3_months,
    HOUSEHOLD_1_151_roll_std_3_months,
    HOUSEHOLD_2_403_roll_avg_3_months,
    FOODS_2_325_roll_std_3_months,
    FOODS_2_181_roll_avg_3_months,
    FOODS_3_572_roll_std_3_months,
    HOBBIES_1_074_roll_std_3_months,
    HOBBIES_2_116_roll_std_3_months,
    HOBBIES_2_115_roll_std_3_months,
    HOBBIES_1_014_roll_avg_3_months,
    FOODS_3_080_roll_avg_3_months,
    FOODS_2_293_roll_std_3_months,
    HOBBIES_1_055_roll_std_3_months,
    HOUSEHOLD_2_160_roll_std_3_months,
    HOBBIES_1_286_roll_avg_3_months,
    HOUSEHOLD_2_350_roll_avg_3_months,
    HOUSEHOLD_2_217_roll_std_3_months,
    HOUSEHOLD_2_447_roll_std_3_months,
    HOUSEHOLD_2_142_roll_std_3_months,
    FOODS_3_228_roll_avg_3_months,
    FOODS_2_030_roll_avg_3_months,
    HOUSEHOLD_1_122_roll_std_3_months,
    fea_month_sin


FROM ${ref("walmart_master_table")} tgt
JOIN ${ref("item_sales_features_ca1")} ca1
    ON ca1.ctx_date_month = tgt.ctx_date_month
WHERE tgt.ctx_store_id = "CA_1"